!function(b){void 0!==b.BatchRemoteList?console.log("BatchRemoteList jQuery plugin init conflict error! Exiting..."):(b.BatchRemoteList=function(t,e){var s=this;s.container=b(t),s.options=e,s.config={},s.form=b("<div>"),s.formTable=b("<table>"),s.inputItemId=b('<input type="number" value="1">'),s.inputProcessLimit=b('<input type="number" min="0">'),s.resultContainer=b("<div>"),s.containerList=b("<div>"),s.finishStatsContainer=b("<div>"),s.submitButton=b('<button type="button">').click(function(t){s.init_process(this,t)}),s.init()},b.BatchRemoteList.prototype={defaults:{classes:{form:"bp-form",table:"bp-form-table",td_label:"bp-form-label",td_input:"bp-form-input",submit_container:"bp-form-submit-container",result_container:"bp-result",list_container:"bp-container-list",stats_container:"bp-stats",finish_stats:"bp-finish-stats"},messages:{start_process:"Start",stop_process:"Stop",start_from_id:"Start from ID",limit_process:"Limit",process_stopped:"Batch process stopped",finish:"Finish",start_time:"Start time",error:"Error",unknown_error:"Unknown error",data_count_empty:"Data empty (items were not found)",data_count_total:"Items total",data_process_left:"Items left",ajax_fail:"Remote resource failed",limit_exceeded:"Limit exceeded",item_not_found:"Item was not found",data_process_success:"Items done",data_process_failed:"Items failed"},ajax_url_count:"/ajax/batch-remote-list/count",ajax_url_item:"/ajax/batch-remote-list/item",ajax_add_data:{},request_throttle:500,callbacks:{}},init:function(){return b.extend(!0,this.config,this.defaults,this.options),this.initCallbacks(),this.buildContainer(),this},initCallbacks:function(){var t,e=this,s=["item_process","item_error","finish"];for(var i in s)t=s[i],e.config.callbacks[t]&&"function"==typeof e.config.callbacks[t]&&(e[t]=e.config.callbacks[t])},curtime:function(){return(new Date).toLocaleString()},buildContainer:function(){this.container.html("").append(this.buildForm(),this.buildResultContainer(),this.buildFinishStatsContainer())},buildResultContainer:function(t){return this.resultContainer.html("").addClass(this.config.classes.result_container)},buildFinishStatsContainer:function(){return this.finishStatsContainer.html("").addClass(this.config.classes.finish_stats)},buildForm:function(){return this.form.addClass(this.config.classes.form).html("").append(this.formTable.addClass(this.config.classes.table).append(b("<tr>").append(b("<td>").text(this.getMessage("start_from_id")+": ").addClass(this.config.classes.td_label),b("<td>").append(this.inputItemId).addClass(this.config.classes.td_input)),b("<tr>").append(b("<td>").text(this.getMessage("limit_process")+": ").addClass(this.config.classes.td_label),b("<td>").append(this.inputProcessLimit).addClass(this.config.classes.td_input))),b("<div>").append(this.submitButton.text(this.getMessage("start_process"))).addClass(this.config.classes.submit_container))},buildContainerList:function(){return this.containerList.html("").addClass(this.config.classes.list_container)},getMessage:function(t){return this.config.messages[t]||t},init_process:function(t,e){function s(t){t&&u.append("<div>"+t+"</div>"),n.data("process-list-status","stopped"),u.append("<div>"+o.getMessage("finish")+": "+o.curtime()+"</div>"),n.text(o.getMessage("start_process")),o.finish()}function i(t){var e="function"==typeof o.config.ajax_add_data?o.config.ajax_add_data():o.config.ajax_add_data;if(e)for(var s in e)t[s]=e[s];return t}var a,n=b(t),o=this,r=this.resultContainer,c=this.inputItemId.val(),d=this.inputProcessLimit.val(),l=this.containerList,u=this.finishStatsContainer,f=0,p=b("<span>"),m=b("<span>"),_=b("<span>"),g=function(t){r.html("").append(b("<div>").addClass(o.config.classes.stats_container).html("").append("<div>"+o.getMessage("start_time")+": "+o.curtime()+"</div>","<div>"+o.getMessage("data_count_total")+": "+t+"</div>",b("<div>"+o.getMessage("data_process_left")+": </div>").append(p.text(t)),b("<div>"+o.getMessage("data_process_success")+": </div>").append(m.text("0")),b("<div>"+o.getMessage("data_process_failed")+": </div>").append(_.text("0"))),o.buildContainerList())},h=function(t){if("stopped"!=n.data("process-list-status")){if(0==p.text())return s();if(0<d&&d<=f)return s(o.getMessage("limit_exceeded")+" ("+d+")");var e=i({id:t||1});b.get(o.config.ajax_url_item,e,function(t){return t.status?(m.text(+m.text()+1),l.append(o.item_process(t.item))):(_.text(+_.text()+1),l.append(o.item_error(t))),t.item?(f++,p.text(p.text()-1),void setTimeout(function(){h(+t.item.id+1)},o.config.request_throttle)):s(o.getMessage("item_not_found"))},"json").fail(function(){s(o.getMessage("ajax_fail")+" ("+o.config.ajax_url_item+")")})}};"processing"==n.data("process-list-status")?s(o.getMessage("process_stopped")):(r.html(""),u.html(""),n.data("process-list-status","processing"),n.text(o.getMessage("stop_process")),o.config.total_count?g(o.config.total_count):(a=i({id:c}),b.get(o.config.ajax_url_count,a,function(t){if(!t.status)return s(o.getMessage("error")+"! "+(t.message||o.getMessage("unknown_error")));var e=t.count||0;if(0==e||isNaN(e))return s(o.getMessage("data_count_empty"));g(e),h(c)},"json").fail(function(){s(o.getMessage("ajax_fail")+" ("+o.config.ajax_url_count+")")})))},item_process:function(t){console.log("item_process item: ",t)},item_error:function(t){console.log("item_error response: ",t)},finish:function(){console.log("process finished")}},b.BatchRemoteList.setDefaults=function(t){b.extend(!0,b.BatchRemoteList.prototype.defaults,t)},b.BatchRemoteList.setDefaultMessages=function(t){b.extend(b.BatchRemoteList.prototype.defaults.messages,t)},b.fn.BatchRemoteList=function(t){return this.each(function(){new b.BatchRemoteList(this,t)})})}(jQuery);