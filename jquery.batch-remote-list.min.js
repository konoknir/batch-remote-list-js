(function(a){if("undefined"!==typeof a.BatchRemoteList)return console.log("BatchRemoteList jQuery plugin init conflict error! Exiting...");a.BatchRemoteList=function(d,h){var c=this;c.container=a(d);c.options=h;c.config={};c.form=a("<div>");c.formTable=a("<table>");c.inputItemId=a('<input type="number" value="1">');c.inputProcessLimit=a('<input type="number" min="0">');c.resultContainer=a("<div>");c.containerList=a("<div>");c.finishStatsContainer=a("<div>");c.submitButton=a('<button type="button">').click(function(b){c.init_process(this,
b)});c.init()};a.BatchRemoteList.prototype={defaults:{classes:{form:"bp-form",table:"bp-form-table",td_label:"bp-form-label",td_input:"bp-form-input",submit_container:"bp-form-submit-container",result_container:"bp-result",list_container:"bp-container-list",stats_container:"bp-stats",finish_stats:"bp-finish-stats"},messages:{start_process:"Start",stop_process:"Stop",start_from_id:"Start from ID",limit_process:"Limit",process_stopped:"Batch process stopped",finish:"Finish",start_time:"Start time",
error:"Error",unknown_error:"Unknown error",data_count_empty:"Data empty (items were not found)",data_count_total:"Items total",data_process_left:"Items left",ajax_fail:"Remote resource failed",limit_exceeded:"Limit exceeded",item_not_found:"Item was not found",data_process_success:"Items done",data_process_failed:"Items failed"},ajax_url_count:"/ajax/batch-remote-list/count",ajax_url_item:"/ajax/batch-remote-list/item",ajax_add_data:{},request_throttle:500,callbacks:{}},init:function(){a.extend(!0,
this.config,this.defaults,this.options);this.initCallbacks();this.buildContainer();return this},initCallbacks:function(){var d=["item_process","item_error"],h;for(h in d){var c=d[h];this.config.callbacks[c]&&"function"===typeof this.config.callbacks[c]&&(this[c]=this.config.callbacks[c])}},curtime:function(){return(new Date).toLocaleString()},buildContainer:function(){this.container.html("").append(this.buildForm(),this.buildResultContainer(),this.buildFinishStatsContainer())},buildResultContainer:function(d){return this.resultContainer.html("").addClass(this.config.classes.result_container)},
buildFinishStatsContainer:function(){return this.finishStatsContainer.html("").addClass(this.config.classes.finish_stats)},buildForm:function(){return this.form.addClass(this.config.classes.form).html("").append(this.formTable.addClass(this.config.classes.table).append(a("<tr>").append(a("<td>").text(this.getMessage("start_from_id")+": ").addClass(this.config.classes.td_label),a("<td>").append(this.inputItemId).addClass(this.config.classes.td_input)),a("<tr>").append(a("<td>").text(this.getMessage("limit_process")+
": ").addClass(this.config.classes.td_label),a("<td>").append(this.inputProcessLimit).addClass(this.config.classes.td_input))),a("<div>").append(this.submitButton.text(this.getMessage("start_process"))).addClass(this.config.classes.submit_container))},buildContainerList:function(){return this.containerList.html("").addClass(this.config.classes.list_container)},getMessage:function(d){return this.config.messages[d]||d},init_process:function(d,h){var c=a(d),b=this,q=this.resultContainer,r=this.inputItemId.val(),
l=this.inputProcessLimit.val(),t=this.containerList,m=this.finishStatsContainer,u=0,k=a("<span>"),n=a("<span>"),p=a("<span>"),g=function(f){f&&m.append("<div>"+f+"</div>");c.data("process-list-status","stopped");m.append("<div>"+b.getMessage("finish")+": "+b.curtime()+"</div>");c.text(b.getMessage("start_process"))},w=function(f){var e="function"===typeof b.config.ajax_add_data?b.config.ajax_add_data():b.config.ajax_add_data;if(e)for(var v in e)f[v]=e[v];return f},z=function(){q.html("");m.html("");
c.data("process-list-status","processing");c.text(b.getMessage("stop_process"));if(b.config.total_count)x(b.config.total_count);else{var f=w({id:r});a.get(b.config.ajax_url_count,f,function(e){if(!e.status)return g(b.getMessage("error")+"! "+(e.message||b.getMessage("unknown_error")));e=e.count||0;if(0==e||isNaN(e))return g(b.getMessage("data_count_empty"));x(e);y(r)},"json").fail(function(){g(b.getMessage("ajax_fail")+" ("+b.config.ajax_url_count+")")})}},x=function(f){q.html("").append(a("<div>").addClass(b.config.classes.stats_container).html("").append("<div>"+
b.getMessage("start_time")+": "+b.curtime()+"</div>","<div>"+b.getMessage("data_count_total")+": "+f+"</div>",a("<div>"+b.getMessage("data_process_left")+": </div>").append(k.text(f)),a("<div>"+b.getMessage("data_process_success")+": </div>").append(n.text("0")),a("<div>"+b.getMessage("data_process_failed")+": </div>").append(p.text("0"))),b.buildContainerList())},y=function(f){if("stopped"!=c.data("process-list-status")){if(0==k.text())return g();if(0<l&&u>=l)return g(b.getMessage("limit_exceeded")+
" ("+l+")");f=w({id:f||1});a.get(b.config.ajax_url_item,f,function(e){e.status?(n.text(+n.text()+1),t.append(b.item_process(e.item))):(p.text(+p.text()+1),t.append(b.item_error(e)));if(!e.item)return g(b.getMessage("item_not_found"));u++;k.text(k.text()-1);setTimeout(function(){y(+e.item.id+1)},b.config.request_throttle)},"json").fail(function(){g(b.getMessage("ajax_fail")+" ("+b.config.ajax_url_item+")")})}};"processing"==c.data("process-list-status")?g(b.getMessage("process_stopped")):z()},item_process:function(d){console.log("item_process item: ",
d)},item_error:function(d){console.log("item_error response: ",d)}};a.BatchRemoteList.setDefaults=function(d){a.extend(!0,a.BatchRemoteList.prototype.defaults,d)};a.BatchRemoteList.setDefaultMessages=function(d){a.extend(a.BatchRemoteList.prototype.defaults.messages,d)};a.fn.BatchRemoteList=function(d){return this.each(function(){new a.BatchRemoteList(this,d)})}})(jQuery);